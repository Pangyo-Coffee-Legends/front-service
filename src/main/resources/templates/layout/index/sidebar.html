<nav class="sidebar bg-dark text-white flex-shrink-0 p-3" style="width: 250px; height: 100vh;">
    <a href="/index" style="text-decoration: none; color: white">
        <h4 class="text-center py-3">
            대시보드 메뉴
        </h4>
    </a>
    <ul class="nav flex-column">
        <li class="nav-item">
            <a
                    class="nav-link dropdown-toggle text-white"
                    href="#"
                    id="sidebarDropdown2"
                    role="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#sidebarDropdownMenu2"
                    aria-expanded="false"
            >
                근태 관리
            </a>
            <ul class="collapse list-unstyled ps-3" id="sidebarDropdownMenu2">
                <li><a href="/weekly-entry-charts" class="nav-link text-white">주간 출입 현황</a></li>
                <li><a href="/real-time" class="nav-link text-white">실시간 출입 현황</a></li>
                <li><a href="/working-hours-statistics" class="nav-link text-white">근무 시간 통계</a></li>
                <li><a href="/analysis" class="nav-link text-white">AI 기반 근태 관리</a></li>
            </ul>
        </li>
<!--        근태 관리 사이드바 추가-->


        <li class="nav-item">
            <a
                    class="nav-link dropdown-toggle text-white"
                    href="#"
                    id="booking"
                    role="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#bookingMenu"
                    aria-expanded="false"
            >
                예약
            </a>
            <ul class="collapse list-unstyled ps-3" id="bookingMenu">
                <li><a href="/booking" class="nav-link text-white">예약하기</a></li>
                <li><a href="/booking/history" class="nav-link text-white">예약 내역</a></li>
                <li><a href="/booking/statistics" class="nav-link text-white">통계</a></li>
            </ul>
        </li>
        <li class="nav-item">
            <a
                    class="nav-link dropdown-toggle text-white"
                    href="#"
                    id="admin"
                    role="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#adminMenu"
                    aria-expanded="false"
            >
                관리자
            </a>
            <ul class="collapse list-unstyled ps-3" id="adminMenu">
                <li><a href="/admin/booking" class="nav-link text-white">예약 현황</a></li>
                <li><a href="/admin/booking/statistics" class="nav-link text-white">전체 통계</a></li>
            </ul>
        </li>
        <li class="nav-item"><a href="/charts" class="nav-link text-white">Charts</a></li>
        <li class="nav-item"><a href="#" class="nav-link text-white">Tables</a></li>
        <li class="nav-item"><a href="/users" class="nav-link text-white">Users</a></li>
        <li class="nav-item">
            <a href="/chatList" class="nav-link text-white">
                ChatList
<!--                {/* 안 읽은 메시지 수를 표시할 배지 (초기에는 숨김) */}-->
                <span class="badge bg-danger ms-1 unread-badge" style="display: none;"></span>
            </a>
        </li>
    </ul>
    <!-- 유저 정보 -->
    <div class="mt-auto pt-3">
        <div class="dropdown">
            <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" id="userName" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                사용자 이름
            </a>
            <ul class="dropdown-menu dropdown-menu-dark" aria-labelledby="sidebarUserDropdown">
                <li><a class="dropdown-item" href="#">내 정보</a></li>
                <li><a class="dropdown-item" href="#">설정</a></li>
                <li><hr class="dropdown-divider"></li>
                <form action="/logout" method="POST" style="display: inline;">
                    <button type="submit" class="dropdown-item">로그아웃</button>
                </form>
            </ul>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>

    <script th:inline="javascript" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
        const loggedInUsername = /*[[${#authentication.principal.username}]]*/ null;

        if (loggedInUsername) {
            console.log("Sidebar: 현재 로그인된 사용자 (username/email): " + loggedInUsername);
        } else {
            console.log("Sidebar: 사용자가 로그인하지 않았습니다.");
        }

        // API 기본 URL (실제 환경에 맞게 수정 필요)
        const SIDEBAR_API_BASE_URL = 'http://localhost:10251'; // 실제 API 서버 주소로 변경해주세요.
        const SIDEBAR_SOCKJS_ENDPOINT = `${SIDEBAR_API_BASE_URL}/ws/chat/connect`; // 예: '/ws-stomp' 또는 서버에서 설정한 엔드포인트
        const UNREAD_COUNT_TOPIC = '/topic/unread-count-updates'; // 백엔드에서 지정한 사용자 구독 경로

        let SIDEBAR_stompClient = null;

        function connectSidebarStomp() {
            // 1. SockJS 클라이언트 생성
            SIDEBAR_stompClient = new SockJS(SIDEBAR_SOCKJS_ENDPOINT);

            // 2. SockJS 클라이언트를 통해 STOMP 클라이언트 생성
            SIDEBAR_stompClient = Stomp.over(SIDEBAR_stompClient);

            SIDEBAR_stompClient.debug = null;

            SIDEBAR_stompClient.connect({}, onSidebarStompConnected, onWsError2); // 헤더는 필요시 추가
        }

        function onSidebarStompConnected() {
            console.log("STOMP 연결 성공!");
            // 채팅 목록 업데이트 신호를 받을 경로 구독
            SIDEBAR_stompClient.subscribe(UNREAD_COUNT_TOPIC, handleUnreadCountUpdate); // 콜백 함수 연결
            console.log(`구독 시작: ${UNREAD_COUNT_TOPIC}`);

            fetchInitialUnreadCount();
        }

        function onWsError2(error) {
            console.error("STOMP 연결 실패:", error);
        }

        // --- 2. STOMP 메시지 수신 시 콜백 함수 ---
        function handleUnreadCountUpdate(message) {
            console.log("사이드 바 안 읽은 메시지 테스트 :", message);
            try {
                const payload  = JSON.parse(message.body);

                // **중요: 이 알림이 나(현재 사용자)를 위한 것인지 확인**
                if (payload && payload.userEmail === userEmail) { // 백엔드가 보낸 이메일과 현재 사용자 이메일 비교
                    console.log(payload);
                    console.log("나에게 온 초대 알림 확인. 채팅 목록 새로고침 실행.");

                    displayUnreadCountBadge(payload.unreadCount); // <<< 목록 새로고침 함수 호출
                } else {
                    // console.log("나에게 온 알림이 아님."); // 디버깅용 로그
                }
            } catch (e) {
                console.error("수신 메시지 파싱 오류:", e);
            }
        }

        // --- 3. UI 업데이트 함수 ---
        function displayUnreadCountBadge(count) {
            const chatListLink = document.querySelector('ul.nav a[href="/chatList"]');
            if (chatListLink) {
                let badge = chatListLink.querySelector('.unread-badge');
                if (!badge) {
                    badge = document.createElement('span');
                    badge.className = 'badge bg-danger ms-1 unread-badge'; // Bootstrap 배지 클래스 예시
                    chatListLink.appendChild(badge);
                }

                if (count > 0) {
                    badge.textContent = count;
                    badge.style.display = 'inline-block';
                } else {
                    badge.style.display = 'none';
                }
            }
        }

        async function fetchInitialUnreadCount() {
            try {
                const response = await fetch(`${SIDEBAR_API_BASE_URL}/api/v1/chat/unread/count`, {
                    method: 'GET',
                    credentials: 'include'
                });

                if(response.ok) {
                    const data = await response.json();
                    console.log("gdgdgdgdg"+data);
                    displayUnreadCountBadge(data);
                } else {
                    displayUnreadCountBadge(0);
                }
            } catch (error) {
                displayUnreadCountBadge(0);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            connectSidebarStomp();
            fetchInitialUnreadCount();
        });

    </script>
</nav>