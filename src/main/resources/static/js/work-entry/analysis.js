document.addEventListener('DOMContentLoaded', function () {
    const form = document.getElementById('analysisForm');
    const promptInput = document.getElementById('promptText');
    const memberInput = document.getElementById('memberSelect');
    const chatBox = document.getElementById('chatBox');
    const threadList = document.getElementById('threadList');
    const createBtn = document.getElementById('createThreadBtn');
    const chartArea = document.getElementById('chartArea');
    const reportBtn = document.getElementById('generateReportBtn');
    const reportMonth = document.getElementById('reportMonth');
    const reportYear = document.getElementById('reportYear');

    let currentThreadId = null;
    let thinkingInterval = null;
    let isSubmitting = false;

    if (reportYear) {
        for (let y = 2000; y <= 2100; y++) {
            const option = document.createElement('option');
            option.value = y;
            option.textContent = `${y}ÎÖÑ`;
            if (y === new Date().getFullYear()) {
                option.selected = true;
            }
            reportYear.appendChild(option);
        }
    }

    if (reportBtn) {
        reportBtn.addEventListener('click', () => {
            const mbNo = memberInput.value.trim();
            const month = parseInt(reportMonth.value, 10);
            const year = parseInt(reportYear.value, 10);

            // ‚úÖ ÏàòÏ†ïÎê®: ÎåÄÌôî ÏÑ†ÌÉù ÌôïÏù∏ Ï∂îÍ∞Ä
            if (!mbNo || isNaN(month) || isNaN(year) || !currentThreadId) {
                alert("ÏÇ¨Ïõê, Ïó∞ÎèÑ, Ïõî, ÎåÄÌôî Î™©Î°ùÏùÑ Î™®Îëê ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.");
                return;
            }

            const keywordMap = {
                "Ï∂úÍ∑º": 1, "ÏßÄÍ∞Å": 2, "Í≤∞Í∑º": 3, "Ïô∏Í∑º": 4,
                "Ïó∞Ï∞®": 5, "Î≥ëÍ∞Ä": 6, "Î∞òÏ∞®": 7, "Í≤ΩÏ°∞ÏÇ¨Ìú¥Í∞Ä": 8
            };

            const statusCodes = Object.values(keywordMap).map(String);

            postWithAuth("https://aiot2.live/api/v1/analysis/reports", {
                mbNo: parseInt(mbNo),
                year,
                month,
                statusCodes
            })
                .then(res => {
                    if (!res.ok) throw new Error(`ÏóêÎü¨ Î∞úÏÉù (status: ${res.status})`);
                    return res.json();
                })
                .then(data => {
                    alert("‚úÖ Î¶¨Ìè¨Ìä∏ Î∂ÑÏÑùÏù¥ ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§.");
                    appendChatMessage('ai', data.fullText, { type: 'typing' });
                    if (currentThreadId) {
                        saveMessage(currentThreadId, 'ai', data.fullText);
                    }
                })
                .catch(err => {
                    console.error("‚ùå Î¶¨Ìè¨Ìä∏ ÏÉùÏÑ± Ïã§Ìå®:", err);
                    alert("Î¶¨Ìè¨Ìä∏ ÏÉùÏÑ±Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.");
                });
        });
    }

    document.getElementById('downloadPdfBtn').addEventListener('click', function () {
        const mbNo = memberInput.value;
        const year = reportYear.value;
        const month = reportMonth.value;

        if (!mbNo || !year || !month) {
            alert("ÏÇ¨Ïõê, Ïó∞ÎèÑ, ÏõîÏùÑ Î™®Îëê ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.");
            return;
        }

        fetch(`https://aiot2.live/api/v1/analysis/reports/pdf?mbNo=${mbNo}&year=${year}&month=${month}`, {
            method: 'GET',
            credentials: 'include'
        })
            .then(res => {
                if (!res.ok) throw new Error("PDF Îã§Ïö¥Î°úÎìú Ïã§Ìå®");
                return res.blob();
            })
            .then(blob => {
                const memberName = memberInput.options[memberInput.selectedIndex].textContent.split('(')[0].trim();
                const today = new Date();
                const fileName = `${memberName}_Í∑ºÌÉú_Î¶¨Ìè¨Ìä∏_${today.getFullYear()}ÎÖÑ_${today.getMonth() + 1}Ïõî.pdf`;

                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = fileName;
                document.body.appendChild(a);
                a.click();
                a.remove();
                window.URL.revokeObjectURL(url);
            })
            .catch(err => {
                console.error("‚ùå PDF Îã§Ïö¥Î°úÎìú Ïò§Î•ò:", err);
                alert("PDF Ï†ÄÏû•Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.");
            });
    });

    if (!form || !promptInput || !memberInput || !chatBox || !threadList || !createBtn || !chartArea) {
        console.error("‚ùó ÌïÑÏàò ÏöîÏÜåÍ∞Ä ÎàÑÎùΩÎêòÏóàÏäµÎãàÎã§. HTML Íµ¨Ï°∞Î•º Îã§Ïãú ÌôïÏù∏ÌïòÏÑ∏Ïöî.");
        return;
    }
    /*
    member-service API Ìò∏Ï∂úÌïòÏó¨ ÎìúÎ°≠Îã§Ïö¥ÏúºÎ°ú Îß¥Î≤ÑÎ≤àÌò∏ÏôÄ Ïù¥Î¶ÑÏúºÎ°ú ÏßÅÍ¥ÄÏ†ÅÏúºÎ°ú Ï∞æÏùÑ Ïàò ÏûàÏùå
     */
    fetch('https://aiot2.live/api/v1/members?page=0&size=100', {credentials: 'include'})
        .then(res => res.json())
        .then(data => {
            if (!data.content || data.content.length === 0) {
                console.warn("‚ùó Î©§Î≤Ñ Îç∞Ïù¥ÌÑ∞Í∞Ä ÎπÑÏñ¥ ÏûàÏäµÎãàÎã§.");
                return;
            }
            data.content.forEach(member => {
                const option = document.createElement('option');
                option.value = member.no;
                option.textContent = `${member.name} (${member.no})`;
                memberInput.appendChild(option);
            });
        })
        .catch(err => {
            console.error("‚ùå Î©§Î≤Ñ API Ìò∏Ï∂ú Ïã§Ìå®:", err);
        });

    promptInput.addEventListener('keydown', function (e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();

            if(isSubmitting) return;

            form.dispatchEvent(new Event('submit'));
        }
    });

    function postWithAuth(url, data) {
        return fetch(url, {
            method: 'POST',
            credentials: 'include',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
    }

    function appendChatMessage(role, content, options = {}) {
        const wrapper = document.createElement('div');
        wrapper.className = role === 'user' ? 'text-end mb-3' : 'text-start mb-3';

        const bubble = document.createElement('div');
        bubble.className = role === 'user'
            ? 'bg-primary text-white p-3 rounded shadow-sm d-inline-block position-relative'
            : 'bg-light border p-3 rounded shadow-sm d-inline-block position-relative';

        const contentBox = document.createElement('div');
        bubble.appendChild(contentBox);
        wrapper.appendChild(bubble);
        chatBox.appendChild(wrapper);
        chatBox.scrollTop = chatBox.scrollHeight;

        const renderedHtml = window.marked ? marked.parse(content) : content;

        if (options.type === 'thinking') {
            contentBox.textContent = 'AIÍ∞Ä ÏÉùÍ∞ÅÏ§ëÏûÖÎãàÎã§';
            let dotCount = 0;
            thinkingInterval = setInterval(() => {
                dotCount = (dotCount + 1) % 4;
                contentBox.textContent = 'AIÍ∞Ä ÏÉùÍ∞ÅÏ§ëÏûÖÎãàÎã§' + '.'.repeat(dotCount);
            }, 300);
            // Ï±ÑÌåÖ Ï∂îÍ∞Ä ÌõÑ ÏûêÎèô Ïä§ÌÅ¨Î°§
            setTimeout(() => {
                wrapper.scrollIntoView({behavior: 'smooth', block: 'end'});
            }, 10);

            return;
        }

        if (options.type === 'typing') {
            contentBox.innerHTML = '';
            const tempEl = document.createElement('div');
            tempEl.innerHTML = renderedHtml;
            const fullHtml = tempEl.textContent || tempEl.innerText || content || '';

            // üí° Î†åÎçîÎßÅ ÌÖçÏä§Ìä∏ ÎπÑÏóàÏùÑ ÎïåÎäî Î∞îÎ°ú Ï†ÑÏ≤¥ Ï∂úÎ†•
            if (!fullHtml.trim()) {
                contentBox.innerHTML = renderedHtml || '(Ï∂úÎ†• ÏóÜÏùå)';
                if (role === 'ai') appendCopyButton(bubble, content);
                return;
            }

            const splitter = new GraphemeSplitter();
            const splitText = splitter.splitGraphemes(fullHtml);
            let index = 0;

            const interval = setInterval(() => {
                if (index < splitText.length) {
                    contentBox.textContent += splitText[index++];
                    chatBox.scrollTop = chatBox.scrollHeight;
                } else {
                    clearInterval(interval);
                    contentBox.innerHTML = renderedHtml;
                    if (role === 'ai') appendCopyButton(bubble, content);
                }
            }, 20);
        }
    }

        function appendCopyButton(bubble, content) {
        const copyBtn = document.createElement('button');
        copyBtn.textContent = 'üìã Î≥µÏÇ¨';
        copyBtn.className = 'btn btn-sm btn-outline-secondary position-absolute top-0 end-0 m-2';
        copyBtn.style.fontSize = '0.75rem';
        copyBtn.addEventListener('click', () => {
            navigator.clipboard.writeText(content).then(() => {
                copyBtn.textContent = '‚úÖ Î≥µÏÇ¨ ÏôÑÎ£å';
                copyBtn.disabled = true;
            }).catch(err => {
                console.error("‚ùå ÌÅ¥Î¶ΩÎ≥¥Îìú Î≥µÏÇ¨ Ïã§Ìå®", err);
                copyBtn.textContent = '‚ö†Ô∏è Ïã§Ìå®';
            });
        });
        bubble.appendChild(copyBtn);
    }

    function createChartCanvas(title, labels, data, color, type) {
        const canvas = document.createElement('canvas');
        const wrapper = document.createElement('div');
        wrapper.className = 'text-start mb-4';
        wrapper.style.height = '300px';
        wrapper.appendChild(canvas);
        chartArea.innerHTML = '';
        chartArea.appendChild(wrapper);

        new Chart(canvas.getContext('2d'), {
            type: type,
            data: {
                labels: labels,
                datasets: [{
                    label: title,
                    data: data,
                    backgroundColor: color,
                    borderColor: color,
                    fill: type !== 'line'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: type === 'bar' ? {
                    y: { beginAtZero: true, ticks: { stepSize: 1 } }
                } : {}
            }
        });
    }

    function parseTextChart(content) {
        const patterns = [
            /(\d{4}-\d{1,2}-\d{1,2})\s*\([Í∞Ä-Ìû£]+\):.*?Í∑ºÎ¨¥ÏãúÍ∞Ñ\s*(\d+)\s*ÏãúÍ∞Ñ/g,
            /- (\d{4}-\d{2}-\d{2})\s*\([Í∞Ä-Ìû£]+\)\s*=\s*(\d+)\s*ÏãúÍ∞Ñ/g,
            /(\d{4}-\d{2}-\d{2})\s*Í∑ºÎ¨¥ÏãúÍ∞Ñ.*?(\d+)\s*ÏãúÍ∞Ñ/g,
            /"ÎÇ†Ïßú":\s*"(.*?)".*?"Í∑ºÎ¨¥ÏãúÍ∞Ñ":\s*"(\d+)"/g
        ];
        for (const pattern of patterns) {
            const matches = [...content.matchAll(pattern)];
            if (matches.length > 0) {
                const labels = matches.map(m => m[1].padStart(10, '0'));
                const data = matches.map(m => parseInt(m[2], 10));
                createChartCanvas("ÏùºÎ≥Ñ Í∑ºÎ¨¥ÏãúÍ∞Ñ", labels, data, "#9850ea", "bar");
                return;
            }
        }
    }

    function saveMessage(threadId, role, content) {
        if (!threadId) return Promise.resolve();
        return postWithAuth('https://aiot2.live/api/v1/analysis/histories', {threadId, role, content});

    }

    function loadThreads(memberNo) {
        fetch(`https://aiot2.live/api/v1/analysis/members/${memberNo}/threads`, { credentials: 'include' })
            .then(res => res.json())
            .then(data => {
                threadList.innerHTML = '';
                data.forEach(thread => {
                    const li = document.createElement('li');
                    li.className = 'list-group-item d-flex justify-content-between align-items-center';

                    const titleSpan = document.createElement('span');
                    titleSpan.textContent = thread.title;
                    titleSpan.className = 'flex-grow-1';
                    titleSpan.style.cursor = 'pointer';
                    titleSpan.onclick = () => {
                        currentThreadId = thread.threadId;
                        loadHistory(thread.threadId);
                    };

                    const btnGroup = document.createElement('div');
                    btnGroup.className = 'd-flex align-items-center';

                    const editBtn = document.createElement('button');
                    editBtn.innerHTML = '<i class="bi bi-pencil-square"></i>';
                    editBtn.className = 'btn btn-sm btn-outline-secondary me-1';
                    editBtn.title = 'ÏàòÏ†ï';
                    editBtn.onclick = (e) => {
                        e.stopPropagation();
                        let newTitle = prompt('ÏÉà ÎåÄÌôî Ï†úÎ™©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî', thread.title);
                        while (newTitle !== null) {
                            if (!newTitle.trim()) {
                                alert("Ï†úÎ™©ÏùÄ Í≥µÎ∞±Ïùº Ïàò ÏóÜÏäµÎãàÎã§.");
                                newTitle = prompt('ÏÉà ÎåÄÌôî Ï†úÎ™©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî', thread.title);
                                continue;
                            }
                            if (confirm(`"${newTitle}"(Ïúº)Î°ú ÏàòÏ†ïÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) {
                                fetch(`https://aiot2.live/api/v1/analysis/threads/${thread.threadId}`, {
                                    method: 'PUT',
                                    credentials: 'include',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ title: newTitle.trim() })
                                }).then(res => {
                                    if (res.ok) {
                                        alert("‚úÖ Ï†úÎ™©Ïù¥ ÏàòÏ†ïÎêòÏóàÏäµÎãàÎã§.");
                                        loadThreads(memberNo);
                                    } else {
                                        alert("‚ùå Ï†úÎ™© ÏàòÏ†ïÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.");
                                    }
                                });
                                break;
                            } else {
                                newTitle = prompt('‚úèÔ∏è ÏÉà ÎåÄÌôî Ï†úÎ™©ÏùÑ Îã§Ïãú ÏûÖÎ†•ÌïòÏÑ∏Ïöî', newTitle);
                            }
                        }
                    };

                    const deleteBtn = document.createElement('button');
                    deleteBtn.innerHTML = '<i class="bi bi-trash"></i>';
                    deleteBtn.className = 'btn btn-sm btn-outline-danger';
                    deleteBtn.title = 'ÏÇ≠Ï†ú';
                    deleteBtn.onclick = (e) => {
                        e.stopPropagation();
                        if (confirm(`"${thread.title}" ÎåÄÌôîÎ•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) {
                            fetch(`https://aiot2.live/api/v1/analysis/threads/${thread.threadId}`, {
                                method: 'DELETE',
                                credentials: 'include'
                            }).then(res => {
                                if (res.status === 204) {
                                    alert(`"${thread.title}"Ïù¥(Í∞Ä) ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.`);
                                    loadThreads(memberNo);
                                    chatBox.innerHTML = '';
                                    chartArea.innerHTML = '';
                                } else {
                                    alert("‚ùå ÏÇ≠Ï†ú Ïã§Ìå®");
                                }
                            });
                        }
                    };

                    btnGroup.appendChild(editBtn);
                    btnGroup.appendChild(deleteBtn);
                    li.appendChild(titleSpan);
                    li.appendChild(btnGroup);
                    threadList.appendChild(li);
                });
            });
    }

    function loadHistory(threadId) {
        if (!threadId) return;
        chatBox.innerHTML = '';
        chartArea.innerHTML = '';
        fetch(`https://aiot2.live/api/v1/analysis/histories/${threadId}`, {credentials: 'include'})
            .then(res => res.json())
            .then(history => {
                history.reverse().forEach(m => appendChatMessage(m.role, m.content));
            });
    }

    form.addEventListener('submit', function (e) {
        e.preventDefault();

        // Ï§ëÎ≥µ Ï†úÏ∂ú Î∞©ÏßÄ
        if (isSubmitting) return;
        isSubmitting = true;

        const memberNo = memberInput.value.trim();
        const prompt = promptInput.value.trim();
        if (!memberNo || !prompt || !currentThreadId) {
            alert('ÏÇ¨ÏõêÎ≤àÌò∏, ÏßàÎ¨∏, ÎåÄÌôî ÏÑ†ÌÉùÏùÑ Î™®Îëê ÏôÑÎ£åÌïòÏÑ∏Ïöî.');
            isSubmitting = false;
            return;
        }

        appendChatMessage('user', prompt);
        saveMessage(currentThreadId, 'user', prompt);
        promptInput.value = '';
        appendChatMessage('ai', '', { type: 'thinking' });

        fetch(`https://aiot2.live/api/v1/attendances/${memberNo}/summary/recent`, {credentials: 'include'})
            .then(res => res.json())
            .then(summaryData => {
                const records = summaryData.content.map(r => ({
                    date: `${r.year}-${r.monthValue}-${r.dayOfMonth}`,
                    dayOfWeek: r.dayOfWeek,
                    statusCode: r.code,
                    inTime: r.inTime,
                    outTime: r.outTime
                }));

                const keywordMap = {
                    "Ï∂úÍ∑º": 1, "ÏßÄÍ∞Å": 2, "Í≤∞Í∑º": 3, "Ïô∏Í∑º": 4,
                    "Ïó∞Ï∞®": 5, "Î≥ëÍ∞Ä": 6, "Î∞òÏ∞®": 7, "Í≤ΩÏ°∞ÏÇ¨Ìú¥Í∞Ä": 8
                };

                const matchedLabels = [];
                const matchedCounts = [];

                Object.entries(keywordMap).forEach(([keyword, code]) => {
                    if (prompt.includes(keyword)) {
                        const filtered = records.filter(r => r.statusCode === code);
                        matchedLabels.push(keyword);
                        matchedCounts.push(filtered.length);
                    }
                });

                if (matchedLabels.length > 0) {
                    createChartCanvas("Í∑ºÌÉú ÏÉÅÌÉúÎ≥Ñ ÏùºÏàò", matchedLabels, matchedCounts, "#7b78ec", "bar");
                }

                const formattedRecords = records.map(r => {
                    let hour = 0;
                    if (r.inTime && r.outTime) {
                        const inHour = parseInt(r.inTime.substring(11, 13), 10);
                        const outHour = parseInt(r.outTime.substring(11, 13), 10);
                        hour = Math.max(0, outHour - inHour);
                    }
                    const label = `${r.date} (${r.dayOfWeek})`;
                    return `* ${label}: ${r.inTime && r.outTime ? `${r.inTime.substring(11, 16)} Ï∂úÍ∑º, ${r.outTime.substring(11, 16)} Ìá¥Í∑º (Í∑ºÎ¨¥ÏãúÍ∞Ñ ${hour}ÏãúÍ∞Ñ)` : `Ï∂úÍ∑º/Ìá¥Í∑º Í∏∞Î°ù ÏóÜÏùå (Í∑ºÎ¨¥ÏãúÍ∞Ñ 0ÏãúÍ∞Ñ)`}`;
                }).join('\n');

                const messagePayload = [
                    { role: 'user', content: prompt },
                    { role: 'user', content: '[Í∑ºÎ¨¥ Í∏∞Î°ù]\n' + formattedRecords }
                ];

                return postWithAuth('https://aiot2.live/api/v1/analysis/customs', {
                    memberNo,
                    messages: messagePayload,
                    workRecords: records
                });
            })
            .then(res => res.json())
            .then(data => {
                if (thinkingInterval) clearInterval(thinkingInterval);
                chatBox.lastChild.remove();
                const result = data.fullText || "‚ö†Ô∏è Î∂ÑÏÑù Í≤∞Í≥º ÏóÜÏùå";
                appendChatMessage('ai', result);
                parseTextChart(result);
                saveMessage(currentThreadId, 'ai', result);
            })
            .catch(err => {
                if (thinkingInterval) clearInterval(thinkingInterval);
                chatBox.lastChild.remove();
                console.error('‚ùå Î∂ÑÏÑù ÌùêÎ¶Ñ Ïò§Î•ò:', err);
                appendChatMessage('ai', `‚ùó Ïò§Î•ò: ${err.message}`);
            })
            .finally(() => {
                isSubmitting = false;
            });
    });

    createBtn.addEventListener('click', () => {
        const mbNo = memberInput.value.trim();
        if (!mbNo || isNaN(mbNo)) {
            alert('Î®ºÏ†Ä ÏÇ¨ÏõêÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.');
            return;
        }
        const title = prompt('ÏÉà ÎåÄÌôî Ï†úÎ™©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî');
        if (!title?.trim()) return;

        postWithAuth('https://aiot2.live/api/v1/analysis/threads', {mbNo, title: title.trim()})
            .then(res => res.json())
            .then(thread => {
                currentThreadId = thread.threadId;
                loadThreads(mbNo);
                chatBox.innerHTML = '';
                chartArea.innerHTML = '';
            });
    });

    memberInput.addEventListener('change', () => {
        const mbNo = memberInput.value.trim();
        if (mbNo) loadThreads(mbNo);
    });
});